{
	"version": "2.0.0",
	"tasks": [
		{
			"type": "shell",
			"group": "build",
			"label": "RM build dir",
			"windows": {
				"command": "rmdir /s /q build",
			},
			"command": "rm -rf build"
		},
		{
			"type": "shell",
			"group": "build",
			"label": "Conan install",
			"command": "conan install . --output-folder=build --build=missing --profile=conanprofile.txt",
			"options": {
				"env": {
					"BUILD_TYPE": "${input:BuildType}",
				},
			},
			"windows": {
				"options": {
					"env": {
						"CXX": "C:/msys64/ucrt64/bin/g++.exe",
						"CC": "C:/msys64/ucrt64/bin/gcc.exe",
						// "CXX": "C:/msys64/ucrt64/bin/clang++.exe",
						// "CC": "C:/msys64/ucrt64/bin/clang.exe",
					}
				}
			}
		},
		{
			"type": "shell",
			"group": "build",
			"label": "CMake configure",
			"command": "cmake .. --preset conan-default -DDI_BUILD_TESTS=ON -DCMAKE_COLOR_DIAGNOSTICS=ON -DCMAKE_CXX_MODULE_STD=${input:ImportStd} -DDI_COMPRESS_TYPES=${env:COMPRESS_TYPES} -DDI_TESTS_LTO=${env:ENABLE_LTO} -DDI_TESTS_DEBUG_SAN=${env:ENABLE_SAN}",
			"options": {
				"cwd": "${workspaceFolder}/build",
				"env": {
					"BUILD_TYPE": "${input:BuildType}",
					"COMPRESS_TYPES": "TRUE",
					"ENABLE_LTO": "TRUE",
					"ENABLE_SAN": "TRUE",
				},
			},
			"windows": {
				"options": {
					"env": {
						"CXX": "C:/msys64/ucrt64/bin/g++.exe",
						"CC": "C:/msys64/ucrt64/bin/gcc.exe",
						// "CXX": "C:/msys64/ucrt64/bin/clang++.exe",
						// "CC": "C:/msys64/ucrt64/bin/clang.exe",
					}
				}
			}
		},
		{
			"type": "shell",
			"group": "build",
			"label": "CMake clean",
			"command": "cmake --build . --target clean",
			"options": {
				"cwd": "${workspaceFolder}/build",
			},
		},
		{
			"type": "shell",
			"group": {
				"kind": "build",
				"isDefault": true
			},
			"label": "CMake build",
			"linux": {
				"command": "time cmake --build . --config ${input:BuildType} && ctest --build-config ${input:BuildType} --output-on-failure"
			},
			"windows": {
				"command": "ptime cmake --build . --config ${input:BuildType} && ctest --build-config ${input:BuildType} --output-on-failure"
			},
			"options": {
				"cwd": "${workspaceFolder}/build",
			},
			"presentation": {
				"clear": true,
				"showReuseMessage": false
			},
		},
		{
			"type": "shell",
			"group": "build",
			"label": "CMake clean reconfigure and build",
			"dependsOn": ["RM build dir", "Conan install", "CMake configure", "CMake build"],
			"dependsOrder": "sequence"
		}
	],
	"inputs": [
		{
			"id": "BuildType",
			"type": "pickString",
			"options": [
				"Debug",
				"RelWithDebInfo",
				"Release",
			],
			"description": "Build config to use"
		},
		{
			"id": "ImportStd",
			"type": "pickString",
			"options": ["ON", "OFF"],
			"description": "Whether to use 'import std'"
		}
	],
}
